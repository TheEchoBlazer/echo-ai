<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Echo-AI — Local Mode</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%236ee7ff'/></svg>">
  <style>
    :root {
      --bg: #0b0f14;
      --ink: #e8eef9;
      --muted: #9aa6bb;
      --line: #20304a;
      --hi: #6ee7ff;
      --hi2: #8b5cf6;
      --skin: #f1c38a;
      --shirt: #2b3560;
      --strap: #303a58;
      --mouth: #3b0d0d;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap { max-width: 960px; margin: 0 auto; padding: 16px; }
    header { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .brand { display: flex; align-items: center; gap: 10px; }
    .logo {
      width: 28px; height: 28px; border-radius: 8px;
      background: conic-gradient(from 0deg, var(--hi), var(--hi2), var(--hi));
      box-shadow: 0 0 22px #6ee7ff55 inset, 0 0 30px #8b5cf644;
    }
    h1 { margin: 0; font-size: 18px; }
    .sub { font-size: 12px; color: var(--muted); }
    .status { font-size: 12px; color: #a9b5c9; margin-top: 6px; }
    .stage {
      position: relative; height: 420px; border: 1px solid var(--line); border-radius: 16px;
      background: linear-gradient(#0e1523 0 48%, #0b0f14 48% 100%); overflow: hidden; margin-top: 12px;
    }
    .ground {
      position: absolute; inset: auto 0 0 0; height: 80px;
      background: radial-gradient(800px 120px at 50% 0%, #101829 0, #0c101b 60%, #0b0f14 100%);
      border-top: 1px solid #1e2a47;
    }
    .shadow {
      position: absolute; left: 50%; bottom: 70px; transform: translateX(-50%);
      width: 180px; height: 22px; background: radial-gradient(closest-side, #0006, #0000);
      filter: blur(4px); opacity: 0.2;
    }
    .rig {
      position: absolute; left: 50%; top: -380px; transform: translateX(-50%);
      width: 220px; height: 380px; pointer-events: none; will-change: transform;
      animation: drop 2s cubic-bezier(.2, .8, .1, 1) forwards, sway 2s ease-in-out infinite;
    }
    @keyframes sway {
      0% { transform: translateX(-50%); }
      25% { transform: translateX(calc(-50% - 24px)) rotate(-3.5deg); }
      50% { transform: translateX(-50%); }
      75% { transform: translateX(calc(-50% + 24px)) rotate(3.5deg); }
      100% { transform: translateX(-50%); }
    }
    @keyframes drop {
      0% { top: -380px; }
      70% { top: 250px; }
      82% { top: 236px; }
      100% { top: 242px; }
    }
    .land { animation: thump .25s ease-out; }
    @keyframes thump {
      0% { transform: translateX(-50%) scale(1); }
      50% { transform: translateX(calc(-50% - 2px)) scale(1.04, .96); }
      100% { transform: translateX(-50%) scale(1); }
    }
    .mouth {
      transform-origin: 50% 0; transition: transform .06s linear;
    }
    .talk { transform: scaleY(1.35); }
    .card {
      background: #0f1625; border: 1px solid var(--line); border-radius: 16px;
      overflow: hidden; margin-top: 12px;
    }
    .chat {
      height: 240px; overflow: auto; padding: 12px;
    }
    .row { display: flex; gap: 10px; margin: 8px 0; }
    .me { justify-content: flex-end; }
    .msg {
      max-width: 80%; padding: 10px 12px; border: 1px solid var(--line);
      border-radius: 12px; white-space: pre-wrap; overflow-wrap: anywhere;
    }
    .mine { background: #1b2742; }
    .theirs { background: #141b2c; }
    .toolbar {
      display: flex; gap: 8px; padding: 10px; border-top: 1px solid var(--line);
      background: #0d1424;
    }
    textarea, button, select {
      border-radius: 12px; border: 1px solid var(--line); background: #0e1626;
      color: var(--ink);
    }
    textarea {
      flex: 1; min-height: 64px; padding: 10px; resize: vertical;
    }
    button {
      padding: 9px 12px; font-weight: 800; cursor: pointer;
    }
    .action {
      background: linear-gradient(90deg, var(--hi2), var(--hi));
      color: #061019; border: none;
    }
    .engine {
      display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;
    }
    .chips {
      display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px;
    }
    .chip {
      padding: 6px 10px; border: 1px solid var(--line); background: #0e1420;
      border-radius: 999px; color: #a8b3c6; cursor: pointer;
    }
    .tiny {
      font-size: 12px; color: #9aa6bb;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Echo-AI — Local Mode</h1>
          <div class="sub">Run locally with WebLLM (updated Oct 2025).</div>
        </div>
      </div>
      <div id="status" class="status" role="status">Ready</div>
    </header>

    <div class="engine">
      <select id="model" aria-label="Select AI model">
        <option value="Llama-3.2-1B-Instruct-q4f16_1-MLC">Llama-3.2-1B (small, fast)</option>
        <option value="Phi-3-mini-4k-instruct-q4f16_1-MLC">Phi-3-mini (code-oriented)</option>
        <option value="Qwen2.5-1.5B-Instruct-q4f16_1-MLC">Qwen2.5-1.5B (balanced)</option>
        <option value="Mistral-7B-Instruct-v0.3-q4f16_1-MLC">Mistral-7B (advanced)</option>
      </select>
      <button id="loadLocal" class="action" type="button">Load Model</button>
      <span class="tiny">v0.2.79 | Requires WebGPU (Chrome/Edge 113+).</span>
    </div>

    <div class="stage" id="stage" role="region" aria-label="Animation stage">
      <div class="shadow" id="shadow"></div>
      <div class="rig land" id="rig" aria-label="Ralfy with parachute">
        <svg viewBox="0 0 260 300" width="220" height="380">
          <path d="M50,30 Q130,10 210,30 Q210,80 130,100 Q50,80 50,30" fill="var(--hi2)" stroke="var(--line)" stroke-width="2"/>
          <line x1="90" y1="80" x2="120" y2="120" stroke="var(--strap)" stroke-width="4"/>
          <line x1="170" y1="80" x2="140" y2="120" stroke="var(--strap)" stroke-width="4"/>
          <circle cx="130" cy="150" r="20" fill="var(--skin)"/>
          <rect x="110" y="170" width="40" height="60" fill="var(--shirt)"/>
          <rect x="115" y="135" width="30" height="10" fill="var(--mouth)" class="mouth"/>
        </svg>
      </div>
      <div class="ground"></div>
    </div>

    <div class="card">
      <div class="chat" id="chat" role="log" aria-live="polite"></div>
      <div class="toolbar">
        <textarea id="input" placeholder="Type your message (e.g., 'make a quake mace skript')..." aria-label="Message input"></textarea>
        <button id="send" class="action" type="button">Send</button>
      </div>
    </div>

    <div class="chips">
      <button class="chip" type="button">Code</button>
      <button class="chip" type="button">Debug</button>
      <button class="chip" type="button">Explain</button>
    </div>
  </div>

  <!-- WebLLM v0.2.79 CDN -->
  <script src="https://unpkg.com/@mlc-ai/web-llm@0.2.79/dist/web-llm.umd.min.js"></script>
  <script>
    // Mock fallback
    function getMockAIResponse(message) {
      return `Echo-AI: You said "${message}". WebLLM not loaded—check console for errors.`;
    }

    // WebLLM globals
    let engine = null;

    // Initialize engine
    async function initWebLLM(modelId) {
      if (!window.webllm) {
        console.error('WebLLM not loaded from CDN.');
        return false;
      }
      try {
        console.log(`Loading model: ${modelId}...`);
        engine = await window.webllm.CreateMLCEngine(modelId, {
          initProgressCallback: (report) => {
            console.log(`Progress: ${report.text} (${report.progress}% done)`);
            document.getElementById('status').textContent = `Loading: ${report.text}`;
          }
        });
        console.log(`Model ${modelId} loaded successfully.`);
        return true;
      } catch (e) {
        console.error('WebLLM init failed:', e.message);
        return false;
      }
    }

    // Get response (streaming support)
    async function getWebLLMResponse(message) {
      if (!engine) return 'Error: Load a model first.';
      try {
        const response = await engine.chat.completions.create({
          model: engine.modelId,
          messages: [{ role: 'user', content: message }],
          stream: false, // Set to true for real-time streaming
          max_tokens: 512,
          temperature: 0.7
        });
        return `Echo-AI: ${response.choices[0].message.content}`;
      } catch (e) {
        console.error('WebLLM response failed:', e.message);
        return 'Error: Response generation failed.';
      }
    }

    // WebGPU check on load
    document.addEventListener('DOMContentLoaded', () => {
      const status = document.getElementById('status');
      if (!navigator.gpu) {
        status.textContent = 'Error: WebGPU unsupported. Use Chrome/Edge 113+. Test at webgpureport.org.';
        console.error('WebGPU unavailable.');
      } else {
        status.textContent = 'Ready. Select & load a model.';
      }
    });

    // Load button
    document.getElementById('loadLocal').addEventListener('click', async () => {
      const status = document.getElementById('status');
      const model = document.getElementById('model').value;
      status.textContent = 'Initializing WebGPU...';
      await initWebLLM(model);
      status.textContent = engine ? `Model ${model} loaded.` : 'Load failed—check console.';
    });

    // Send button
    document.getElementById('send').addEventListener('click', async () => {
      const input = document.getElementById('input');
      const chat = document.getElementById('chat');
      const message = input.value.trim();
      if (message) {
        // User message
        const row = document.createElement('div');
        row.className = 'row me';
        row.innerHTML = `<div class="msg mine">${message}</div>`;
        chat.appendChild(row);
        input.value = '';
        chat.scrollTop = chat.scrollHeight;

        // AI response
        const aiRow = document.createElement('div');
        aiRow.className = 'row';
        chat.appendChild(aiRow);
        chat.scrollTop = chat.scrollHeight;

        const response = engine ? await getWebLLMResponse(message) : getMockAIResponse(message);
        aiRow.innerHTML = `<div class="msg theirs">${response}</div>`;
        chat.scrollTop = chat.scrollHeight;

        // Mouth animation
        const mouth = document.querySelector('.mouth');
        mouth.classList.add('talk');
        setTimeout(() => mouth.classList.remove('talk'), 300);
      }
    });

    // Chips
    document.querySelectorAll('.chip').forEach(chip => {
      chip.addEventListener('click', async () => {
        const chat = document.getElementById('chat');
        const message = `Generate ${chip.textContent.toLowerCase()} for a Minecraft Skript.`;
        const row = document.createElement('div');
        row.className = 'row me';
        row.innerHTML = `<div class="msg mine">${message}</div>`;
        chat.appendChild(row);
        chat.scrollTop = chat.scrollHeight;

        const aiRow = document.createElement('div');
        aiRow.className = 'row';
        chat.appendChild(aiRow);
        chat.scrollTop = chat.scrollHeight;

        const response = engine ? await getWebLLMResponse(message) : getMockAIResponse(message);
        aiRow.innerHTML = `<div class="msg theirs">${response}</div>`;
        chat.scrollTop = chat.scrollHeight;

        const mouth = document.querySelector('.mouth');
        mouth.classList.add('talk');
        setTimeout(() => mouth.classList.remove('talk'), 300);
      });
    });
  </script>
</body>
</html>
