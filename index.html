<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Echo-AI (No Key, Local WebLLM)</title>
<style>
  :root{ --bg:#0b0f14; --ink:#e9eef7; --muted:#a8b3c6; --line:#223048; --hi:#6ee7ff; --hi2:#8b5cf6; }
  *{box-sizing:border-box}
  body{margin:0;background:#0b0f14;color:var(--ink);font:14px/1.5 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:900px;margin:0 auto;padding:16px}
  .hdr{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:28px;height:28px;border-radius:8px;background:conic-gradient(from 0deg,var(--hi),var(--hi2),var(--hi));box-shadow:0 0 22px #6ee7ff55 inset,0 0 30px #8b5cf644}
  h1{font-size:18px;margin:0}
  .sub{font-size:12px;color:var(--muted)}
  .card{background:#0f1625;border:1px solid var(--line);border-radius:16px;overflow:hidden;margin-top:12px}
  .chat{height:58vh;min-height:360px;overflow:auto;padding:12px}
  .row{display:flex;gap:10px;margin:10px 0}
  .me{justify-content:flex-end}
  .msg{max-width:80%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;white-space:pre-wrap;word-wrap:anywhere}
  .mine{background:#1b2742}
  .theirs{background:#141b2c}
  .code{display:block;background:#0b1120;border:1px solid #1a2742;border-radius:10px;padding:8px;overflow:auto;margin:8px 0}
  .toolbar{display:flex;gap:8px;padding:10px;border-top:1px solid var(--line);background:#0d1424}
  textarea{flex:1 1 auto;min-height:56px;max-height:180px;resize:vertical;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0e1626;color:var(--ink)}
  select,button{border-radius:10px;border:1px solid var(--line);background:#0e1626;color:var(--ink);padding:9px 12px}
  button.action{background:linear-gradient(90deg,var(--hi2),var(--hi));color:#061019;border:none;font-weight:800}
  .hint{color:var(--muted);font-size:12px;margin-top:6px}
  .status{font-size:12px;color:#a9b5c9;margin-top:6px}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .chip{padding:6px 10px;border:1px solid var(--line);background:#0e1420;border-radius:999px;color:#a8b3c6;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Echo-AI — Skript & GTag (No Key)</h1>
        <div class="sub">Runs locally with WebLLM. Open this URL directly (not embedded).</div>
      </div>
    </div>
    <div class="bar">
      <select id="model">
        <option value="Phi-3.5-mini-instruct-q4f16_1-MLC">Phi-3.5-mini-instruct (smallest)</option>
        <option value="Qwen2.5-Coder-1.5B-Instruct-q4f16_1-MLC">Qwen2.5-Coder-1.5B (best for code)</option>
        <option value="Llama-3.1-3B-Instruct-q4f16_1-MLC">Llama-3.1-3B-Instruct</option>
      </select>
      <button id="load" class="action">Load Model</button>
    </div>
  </div>

  <div class="card">
    <div id="chat" class="chat"></div>
    <div class="toolbar">
      <textarea id="in" placeholder="e.g., “Skript: /dupe up to 4; block &cHeart; 5s cooldown; perm echo.dupe.”"></textarea>
      <button id="send">Send</button>
    </div>
  </div>

  <div class="chips">
    <div class="chip" data-text="Skript: command /dupe that duplicates held item up to 4; deny if item's name contains &cHeart or if custom model data is 123. Include cooldown 5s and permission echo.dupe.">/dupe up to 4 + block hearts</div>
    <div class="chip" data-text="Skript: 'Quacke Mace' with right-click wind burst (level 5), shift-right-click ground slam; base damage ~9 hearts; only one exists server-wide; crafting recipe; admin bypass perm quacke.admin.">Quacke Mace</div>
    <div class="chip" data-text="Unity (GTag): C# MonoBehaviour that toggles Ghost Monkey + Snowball Spam via wrist UI; Photon PUN 2 safe RPCs.">GTag wrist toggle</div>
  </div>

  <div id="status" class="status">Ready. Click “Load Model”.</div>
  <div class="hint">If “Load Model” stalls, make sure you opened the GitHub Pages URL directly and you’re on Chrome/Edge desktop. WebGPU helps; it can fallback to WASM (slower).</div>
</div>

<!-- 1) Try local copy (recommended). Put lib/web-llm.umd.min.js in your repo. -->
<script src="./lib/web-llm.umd.min.js"></script>
<!-- 2) Fallbacks if local is missing -->
<script>
(async ()=>{
  function loaded(){ return !!window.webllm; }
  async function addScript(src){
    return new Promise(res=>{
      const s=document.createElement('script'); s.src=src; s.async=true;
      s.onload=()=>res(true); s.onerror=()=>res(false); document.head.appendChild(s);
    });
  }
  if (!loaded()){
    await addScript("https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.55/dist/web-llm.umd.min.js");
  }
  if (!loaded()){
    await addScript("https://unpkg.com/@mlc-ai/web-llm@0.2.55/dist/web-llm.umd.min.js");
  }
  if (!loaded()){
    document.getElementById('status').textContent =
      "Couldn’t load WebLLM. Add lib/web-llm.umd.min.js to your repo, or try another browser.";
  }
})();
</script>

<script>
const $ = s => document.querySelector(s);
const chatEl = $("#chat"), inputEl = $("#in"), sendBtn = $("#send");
const modelEl = $("#model"), loadBtn = $("#load"), statusEl = $("#status");

let engine=null;
const history=[{role:"system", content:
`You are a focused coding helper for Minecraft Skript (Minehut/Purpur/1.21.x, SkBee) and Gorilla Tag/Unity 2021.3.21f1 (Photon PUN 2, PlayFab).
Rules:
- Return code in triple backticks with language tags: \`\`\`skript\`\`\`, \`\`\`csharp\`\`\`, \`\`\`json\`\`\`, etc.
- Skript: include permissions, simple cooldowns, deny messages; avoid deprecated syntaxes.
- Unity: include needed 'using' lines; keep snippets drop-in; explain only critical setup.
- If a request is unsafe or against platform rules, refuse briefly and suggest a safer alternative.
- Be concise.`}];

function escapeHtml(s){return String(s).replace(/[<>&]/g,c=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[c]));}
function renderMarkdownLite(t){
  const parts=String(t).split(/```/); let out="";
  for(let i=0;i<parts.length;i++){
    if(i%2===0) out+=escapeHtml(parts[i]).replace(/\n/g,"<br>");
    else{ const nl=parts[i].indexOf("\n"); let lang="txt",code=parts[i];
      if(nl!==-1){ lang=parts[i].slice(0,nl).trim()||"txt"; code=parts[i].slice(nl+1); }
      out+=`<pre class="code"><code data-lang="${lang}">${escapeHtml(code)}</code></pre>`;
    }
  } return out;
}
function addBubble(role,text){
  const row=document.createElement("div");
  row.className="row"+(role==="user"?" me":"");
  const msg=document.createElement("div");
  msg.className="msg "+(role==="user"?"mine":"theirs");
  msg.innerHTML=renderMarkdownLite(text);
  row.appendChild(msg); chatEl.appendChild(row); chatEl.scrollTop=chatEl.scrollHeight;
}
function setStatus(m){ statusEl.textContent=m; }

loadBtn.addEventListener("click", async ()=>{
  if(!window.webllm){ setStatus("WebLLM script missing. See note above."); return; }
  const { CreateMLCEngine, prebuiltAppConfig } = window.webllm;
  const modelId = modelEl.value;
  setStatus(`Loading ${modelId}…`);
  sendBtn.disabled = true;
  try{
    engine = await CreateMLCEngine(modelId, {
      appConfig: prebuiltAppConfig,
      useWebWorker: false,   // main-thread mode (works on GH Pages)
      gpu: true              // tries WebGPU, falls back internally
    }, (p)=> setStatus(`${p.text} ${Math.round(p.progress*100)}%`));
    setStatus(`Loaded ${modelId}. Type and hit Send.`);
  }catch(e){
    setStatus(`Load error: ${e.message}`);
  }
});

async function send(){
  const text=inputEl.value.trim();
  if(!text || !engine) return;
  inputEl.value=""; inputEl.focus(); sendBtn.disabled=true;
  addBubble("user",text);
  try{
    const msgs=history.concat([{role:"user",content:text}]);
    const out=await engine.chat.completions.create({messages:msgs,temperature:0.2,max_tokens:900});
    const reply=out?.choices?.[0]?.message?.content ?? "No response.";
    history.push({role:"user",content:text}); history.push({role:"assistant",content:reply});
    addBubble("assistant",reply);
  }catch(e){
    addBubble("assistant","**Error:** "+escapeHtml(e.message));
  }finally{ sendBtn.disabled=false; }
}
sendBtn.addEventListener("click", send);
inputEl.addEventListener("keydown", e=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send(); }});
document.querySelectorAll(".chip").forEach(ch=> ch.addEventListener("click", ()=>{ inputEl.value=ch.dataset.text; inputEl.focus(); }));
</script>
</body>
</html>



